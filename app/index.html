<!--
  THIS IS THE APP HTML
-->
<html>
  <head>
    <!-- DEBUGGING OUTPUT -->
    <script type="text/javascript">
      console.log(window);
      const mockSMARTClient = {
        tokenResponse: {
          "access_token": "VGhpcyBpcyBhbiBleGFtcGxlIGFjY2Vzc190b2tlbiEK",
          "token_type": "bearer",
          "expires_in": 3600,
          "scope": "patient/Patient.read messaging/ui.launchActivity",
          "smart_messaging_origin": "http://localhost:8000",
          "smart_web_messaging_handle": "ZXhhbXBsZSBoYW5kbGUK",
          "state": "c3RhdGUgZXhhbXBsZSEK",
        }
      }
    </script>

    <!-- Helper functions. -->
    <script type="text/javascript">

    function inspectSMARTClient(client, callback=console.log) {
      // Inspect the client, looking for configuration problems.
      var c = client;
      if (!client.tokenResponse) {
        callback('SMART client missing expected tokenResponse');
        c['tokenResponse'] = {};
      }
      const t = c.tokenResponse;
      if (!t.smart_messaging_origin) {
        callback('SMART client missing attribute "smart_messaging_origin", which is needed for SMART Web Messaging');
      }
      if (!t.smart_web_messaging_handle) {
        callback('SMART client missing attribute "smart_web_messaging_handle", which is needed for SMART Web Messaging');
      }
      return {
        "access_token": t.access_token,
        "token_type": t.token_type,
        "expires_in": t.expires_in,
        "scope": t.scope,
        "smart_web_messaging_handle": t.smart_web_messaging_handle,
        "smart_messaging_origin": t.smart_messaging_origin,
        "state": t.state,
      }
    }

    </script>
  </head>
  <!--
    TODO:
      [ ] attempt to handshake every X seconds
      [ ] determine where logged errors should be seen
      [ ] host this somewhere (personal repo?)
    NICE:
      [ ] add a control panel to determine how often handshakes are done
        [ ] every X seconds
        [ ] only before other operations
        [ ] only once (on load)
        [ ] never
      [ ] actual smart launch against the smart app launcher
      [ ] control panel to configure the launch URL?
      [ ] https url (assuming github.io works)

  -->
  <body>
    <h1>SMART Web Messaging App</h1>
      <table border=1 id="appTable">
      <tr>
        <th>app state</th>
        <th>value</th>
      </tr>
      <tr>
        <td>is embedded in EHR iframe?</td>
        <td id="isEmbedded">uninitialized</td>
      </tr>
      <tr>
        <td>successful handshakes</td>
        <td>0</td>
      </tr>
    </table>

    <!-- Update table above. -->
    <script type="text/javascript">
      const isEmbedded = window.parent !== window.self;
      document.getElementById("isEmbedded").innerText = isEmbedded;
      const clientSettings = inspectSMARTClient(mockSMARTClient, console.log);
      const table = document.getElementById("appTable");
      for (const [key, value] of Object.entries(clientSettings)) {
        const tr = document.createElement('tr');
        const state = document.createElement('td');
        const val = document.createElement('td');
        state.appendChild(document.createTextNode("SMART client." + key));
        val.appendChild(document.createTextNode(value));
        tr.appendChild(state);
        tr.appendChild(val);
        table.appendChild(tr);
      }
      if (window.opener || isEmbedded) {
        const targetWindow = window.parent !== window.self ? window.parent : window.opener;
        targetWindow.postMessage('Hello, world!', clientSettings.smart_messaging_origin);
      } else {
        console.log('Unable to send a window.postMessage - no receiver')
      }
    </script>
  </body>
</html>